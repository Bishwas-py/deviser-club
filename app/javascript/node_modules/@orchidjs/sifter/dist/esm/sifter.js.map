{"version":3,"file":"sifter.js","sources":["../../lib/sifter.ts"],"sourcesContent":["/**\n * sifter.js\n * Copyright (c) 2013â€“2020 Brian Reavis & contributors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this\n * file except in compliance with the License. You may obtain a copy of the License at:\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under\n * the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF\n * ANY KIND, either express or implied. See the License for the specific language\n * governing permissions and limitations under the License.\n *\n * @author Brian Reavis <brian@thirdroute.com>\n */\n\n // @ts-ignore TS2691 \"An import path cannot end with a '.ts' extension\"\nimport { scoreValue, getAttr, getAttrNesting, escape_regex, propToArray, iterate, cmp } from './utils.ts';\n// @ts-ignore TS2691 \"An import path cannot end with a '.ts' extension\"\nimport { diacriticRegexPoints } from './diacritics.ts';\n// @ts-ignore TS2691 \"An import path cannot end with a '.ts' extension\"\nimport * as T from 'types.ts';\n\nexport default class Sifter{\n\n\tpublic items; // []|{};\n\tpublic settings: T.Settings;\n\n\t/**\n\t * Textually searches arrays and hashes of objects\n\t * by property (or multiple properties). Designed\n\t * specifically for autocomplete.\n\t *\n\t */\n\tconstructor(items:any, settings:T.Settings) {\n\t\tthis.items = items;\n\t\tthis.settings = settings || {diacritics: true};\n\t};\n\n\t/**\n\t * Splits a search string into an array of individual\n\t * regexps to be used to match results.\n\t *\n\t */\n\ttokenize(query:string, respect_word_boundaries?:boolean, weights?:T.Weights ):T.Token[] {\n\t\tif (!query || !query.length) return [];\n\n\t\tconst tokens:T.Token[]\t= [];\n\t\tconst words\t\t\t\t= query.split(/\\s+/);\n\t\tvar field_regex:RegExp;\n\n\t\tif( weights ){\n\t\t\tfield_regex = new RegExp( '^('+ Object.keys(weights).map(escape_regex).join('|')+')\\:(.*)$');\n\t\t}\n\n\t\twords.forEach((word:string) => {\n\t\t\tlet field_match;\n\t\t\tlet field:null|string\t= null;\n\t\t\tlet regex:null|string\t= null;\n\n\t\t\t// look for \"field:query\" tokens\n\t\t\tif( field_regex && (field_match = word.match(field_regex)) ){\n\t\t\t\tfield\t= field_match[1];\n\t\t\t\tword\t= field_match[2];\n\t\t\t}\n\n\t\t\tif( word.length > 0 ){\n\t\t\t\tif( this.settings.diacritics ){\n\t\t\t\t\tregex = diacriticRegexPoints(word);\n\t\t\t\t}else{\n\t\t\t\t\tregex = escape_regex(word);\n\t\t\t\t}\n\t\t\t\tif( respect_word_boundaries ) regex = \"\\\\b\"+regex;\n\t\t\t}\n\n\t\t\ttokens.push({\n\t\t\t\tstring : word,\n\t\t\t\tregex  : regex ? new RegExp(regex,'iu') : null,\n\t\t\t\tfield  : field,\n\t\t\t});\n\t\t});\n\n\t\treturn tokens;\n\t};\n\n\n\t/**\n\t * Returns a function to be used to score individual results.\n\t *\n\t * Good matches will have a higher score than poor matches.\n\t * If an item is not a match, 0 will be returned by the function.\n\t *\n\t * @returns {function}\n\t */\n\tgetScoreFunction(query:string, options:T.Options ){\n\t\tvar search = this.prepareSearch(query, options);\n\t\treturn this._getScoreFunction(search);\n\t}\n\n\t_getScoreFunction(search:T.PrepareObj ){\n\t\tconst tokens\t\t= search.tokens,\n\t\ttoken_count\t\t\t= tokens.length;\n\n\t\tif (!token_count) {\n\t\t\treturn function() { return 0; };\n\t\t}\n\n\t\tconst fields\t= search.options.fields,\n\t\tweights\t\t\t= search.weights,\n\t\tfield_count\t\t= fields.length,\n\t\tgetAttrFn\t\t= search.getAttrFn;\n\n\t\tif (!field_count) {\n\t\t\treturn function() { return 1; };\n\t\t}\n\n\n\t\t/**\n\t\t * Calculates the score of an object\n\t\t * against the search query.\n\t\t *\n\t\t */\n\t\tconst scoreObject = (function() {\n\n\n\t\t\tif (field_count === 1) {\n\t\t\t\treturn function(token:T.Token, data:{}) {\n\t\t\t\t\tconst field = fields[0].field;\n\t\t\t\t\treturn scoreValue(getAttrFn(data, field), token, weights[field]);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn function(token:T.Token, data:{}) {\n\t\t\t\tvar sum = 0;\n\n\t\t\t\t// is the token specific to a field?\n\t\t\t\tif( token.field ){\n\n\t\t\t\t\tconst value = getAttrFn(data, token.field);\n\n\t\t\t\t\tif( !token.regex && value ){\n\t\t\t\t\t\tsum += (1/field_count);\n\t\t\t\t\t}else{\n\t\t\t\t\t\tsum += scoreValue(value, token, 1);\n\t\t\t\t\t}\n\n\n\n\t\t\t\t}else{\n\t\t\t\t\titerate(weights, (weight:number, field:string) => {\n\t\t\t\t\t\tsum += scoreValue(getAttrFn(data, field), token, weight);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn sum / field_count;\n\t\t\t};\n\t\t})();\n\n\t\tif (token_count === 1) {\n\t\t\treturn function(data:{}) {\n\t\t\t\treturn scoreObject(tokens[0], data);\n\t\t\t};\n\t\t}\n\n\t\tif (search.options.conjunction === 'and') {\n\t\t\treturn function(data:{}) {\n\t\t\t\tvar i = 0, score, sum = 0;\n\t\t\t\tfor (; i < token_count; i++) {\n\t\t\t\t\tscore = scoreObject(tokens[i], data);\n\t\t\t\t\tif (score <= 0) return 0;\n\t\t\t\t\tsum += score;\n\t\t\t\t}\n\t\t\t\treturn sum / token_count;\n\t\t\t};\n\t\t} else {\n\t\t\treturn function(data:{}) {\n\t\t\t\tvar sum = 0;\n\t\t\t\titerate(tokens,(token:T.Token)=>{\n\t\t\t\t\tsum += scoreObject(token, data);\n\t\t\t\t});\n\t\t\t\treturn sum / token_count;\n\t\t\t};\n\t\t}\n\t};\n\n\t/**\n\t * Returns a function that can be used to compare two\n\t * results, for sorting purposes. If no sorting should\n\t * be performed, `null` will be returned.\n\t *\n\t * @return function(a,b)\n\t */\n\tgetSortFunction(query:string, options:T.Options) {\n\t\tvar search  = this.prepareSearch(query, options);\n\t\treturn this._getSortFunction(search);\n\t}\n\n\t_getSortFunction(search:T.PrepareObj){\n\t\tvar i, n, implicit_score;\n\n\t\tconst self\t= this,\n\t\toptions\t\t= search.options,\n\t\tsort\t\t= (!search.query && options.sort_empty) ? options.sort_empty : options.sort,\n\t\tsort_flds:T.Sort[]\t\t= [],\n\t\tmultipliers:number[]\t= [];\n\n\n\t\tif( typeof sort == 'function' ){\n\t\t\treturn sort.bind(this);\n\t\t}\n\n\t\t/**\n\t\t * Fetches the specified sort field value\n\t\t * from a search result item.\n\t\t *\n\t\t */\n\t\tconst get_field = function(name:string, result:T.ResultItem):string|number {\n\t\t\tif (name === '$score') return result.score;\n\t\t\treturn search.getAttrFn(self.items[result.id], name);\n\t\t};\n\n\t\t// parse options\n\t\tif (sort) {\n\t\t\tfor (i = 0, n = sort.length; i < n; i++) {\n\t\t\t\tif (search.query || sort[i].field !== '$score') {\n\t\t\t\t\tsort_flds.push(sort[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// the \"$score\" field is implied to be the primary\n\t\t// sort field, unless it's manually specified\n\t\tif (search.query) {\n\t\t\timplicit_score = true;\n\t\t\tfor (i = 0, n = sort_flds.length; i < n; i++) {\n\t\t\t\tif (sort_flds[i].field === '$score') {\n\t\t\t\t\timplicit_score = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (implicit_score) {\n\t\t\t\tsort_flds.unshift({field: '$score', direction: 'desc'});\n\t\t\t}\n\t\t} else {\n\t\t\tfor (i = 0, n = sort_flds.length; i < n; i++) {\n\t\t\t\tif (sort_flds[i].field === '$score') {\n\t\t\t\t\tsort_flds.splice(i, 1);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor (i = 0, n = sort_flds.length; i < n; i++) {\n\t\t\tmultipliers.push(sort_flds[i].direction === 'desc' ? -1 : 1);\n\t\t}\n\n\t\t// build function\n\t\tconst sort_flds_count = sort_flds.length;\n\t\tif (!sort_flds_count) {\n\t\t\treturn null;\n\t\t} else if (sort_flds_count === 1) {\n\t\t\tconst sort_fld = sort_flds[0].field;\n\t\t\tconst multiplier = multipliers[0];\n\t\t\treturn function(a:T.ResultItem, b:T.ResultItem) {\n\t\t\t\treturn multiplier * cmp(\n\t\t\t\t\tget_field(sort_fld, a),\n\t\t\t\t\tget_field(sort_fld, b)\n\t\t\t\t);\n\t\t\t};\n\t\t} else {\n\t\t\treturn function(a:T.ResultItem, b:T.ResultItem) {\n\t\t\t\tvar i, result, field;\n\t\t\t\tfor (i = 0; i < sort_flds_count; i++) {\n\t\t\t\t\tfield = sort_flds[i].field;\n\t\t\t\t\tresult = multipliers[i] * cmp(\n\t\t\t\t\t\tget_field(field, a),\n\t\t\t\t\t\tget_field(field, b)\n\t\t\t\t\t);\n\t\t\t\t\tif (result) return result;\n\t\t\t\t}\n\t\t\t\treturn 0;\n\t\t\t};\n\t\t}\n\t};\n\n\t/**\n\t * Parses a search query and returns an object\n\t * with tokens and fields ready to be populated\n\t * with results.\n\t *\n\t */\n\tprepareSearch(query:string, optsUser:Partial<T.Options>):T.PrepareObj {\n\t\tconst weights:T.Weights = {};\n\t\tvar options\t\t= Object.assign({},optsUser);\n\n\t\tpropToArray(options,'sort');\n\t\tpropToArray(options,'sort_empty');\n\n\t\t// convert fields to new format\n\t\tif( options.fields ){\n\t\t\tpropToArray(options,'fields');\n\t\t\tconst fields:T.Field[] = [];\n\t\t\toptions.fields.forEach((field:string|T.Field) => {\n\t\t\t\tif( typeof field == 'string' ){\n\t\t\t\t\tfield = {field:field,weight:1};\n\t\t\t\t}\n\t\t\t\tfields.push(field);\n\t\t\t\tweights[field.field] = ('weight' in field) ? field.weight : 1;\n\t\t\t});\n\t\t\toptions.fields = fields;\n\t\t}\n\n\n\t\treturn {\n\t\t\toptions\t\t: options,\n\t\t\tquery\t\t: query.toLowerCase().trim(),\n\t\t\ttokens\t\t: this.tokenize(query, options.respect_word_boundaries, weights),\n\t\t\ttotal\t\t: 0,\n\t\t\titems\t\t: [],\n\t\t\tweights\t\t: weights,\n\t\t\tgetAttrFn\t: (options.nesting) ? getAttrNesting : getAttr,\n\t\t};\n\t};\n\n\t/**\n\t * Searches through all items and returns a sorted array of matches.\n\t *\n\t */\n\tsearch(query:string, options:T.Options) : T.PrepareObj {\n\t\tvar self = this, score, search:T.PrepareObj;\n\n\t\tsearch  = this.prepareSearch(query, options);\n\t\toptions = search.options;\n\t\tquery   = search.query;\n\n\t\t// generate result scoring function\n\t\tconst fn_score = options.score || self._getScoreFunction(search);\n\n\t\t// perform search and sort\n\t\tif (query.length) {\n\t\t\titerate(self.items, (item:T.ResultItem, id:string|number) => {\n\t\t\t\tscore = fn_score(item);\n\t\t\t\tif (options.filter === false || score > 0) {\n\t\t\t\t\tsearch.items.push({'score': score, 'id': id});\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\titerate(self.items, (_:T.ResultItem, id:string|number) => {\n\t\t\t\tsearch.items.push({'score': 1, 'id': id});\n\t\t\t});\n\t\t}\n\n\t\tconst fn_sort = self._getSortFunction(search);\n\t\tif (fn_sort) search.items.sort(fn_sort);\n\n\t\t// apply limits\n\t\tsearch.total = search.items.length;\n\t\tif (typeof options.limit === 'number') {\n\t\t\tsearch.items = search.items.slice(0, options.limit);\n\t\t}\n\n\t\treturn search;\n\t};\n}\n"],"names":["Sifter","constructor","items","settings","diacritics","tokenize","query","respect_word_boundaries","weights","length","tokens","words","split","field_regex","RegExp","Object","keys","map","escape_regex","join","forEach","word","field_match","field","regex","match","diacriticRegexPoints","push","string","getScoreFunction","options","search","prepareSearch","_getScoreFunction","token_count","fields","field_count","getAttrFn","scoreObject","token","data","scoreValue","sum","value","iterate","weight","conjunction","i","score","getSortFunction","_getSortFunction","n","implicit_score","self","sort","sort_empty","sort_flds","multipliers","bind","get_field","name","result","id","unshift","direction","splice","sort_flds_count","sort_fld","multiplier","a","b","cmp","optsUser","assign","propToArray","toLowerCase","trim","total","nesting","getAttrNesting","getAttr","fn_score","item","filter","_","fn_sort","limit","slice"],"mappings":"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"}